---
title: "Project Data Cleaning"
author: "Katrina Truebebach"
date: "March 4, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
library(stringr)
library(lubridate)
library(qdapTools)
#library(VIM)
#library(corrplot)

```

__Discovery__: The deflator data in the World Bank dataset is in local currency. The budget and revenue data in the movie dataset is also in local currency. Thus I needed to introduce an exchange rate dataset so that everything is in real US dollars.

## Download Data

Keep different file paths for different people
```{r import}
# Qiang's File Paths
#movie <- read_csv("D:/academic/DS 5110 Introduction to Data Management and Processing/project/movie_metadata.csv")
#oscar <- read_csv("D:/academic/DS 5110 Introduction to Data Management and Processing/project/academy_awards.csv")
#deflator <- read_csv("D:/academic/DS 5110 Introduction to Data Management and Processing/project/API_NY.GDP.DEFL.KD.ZG_DS2_en_csv_v2_10473736/API_NY.GDP.DEFL.KD.ZG_DS2_en_csv_v2_10473736.csv", skip = 4)

# Katrina's File Paths
movie <- read_csv("~/DS5110/data/movie_metadata.csv")
oscar <- read_csv("~/DS5110/data/academy_awards.csv")
  # make sure to filter by winners (Winner == 1) and by Actor/Actress and Director
deflator <- read_csv("~/DS5110/data/GDPDEF.csv")
```

## Movie Data Cleaning

Drop some variables we are not using. Rename some variables
```{r movie_drop}
# drop variables we aren't using
movie <- movie %>% select(-c(color, contains('facebook'), starts_with('num_voted'), 
                             contains('link'), aspect_ratio, facenumber_in_poster,
                             plot_keywords))

# rename year variable so matches with keys in other datasets
# also rename country to country_name. 
  # When merge with othere datasets later, need to differentiate between country abbreviations and full names
movie <- movie %>% rename(year = title_year)
```

Clean up string variables: trim white space from all character variables 
```{r movie_string_clean}
movie <- movie %>%
  mutate_if(is.character, str_trim)
```

Drop rows that are entirely duplicated 
```{r movie_duplicate_drop}
sum(duplicated(movie)) # 120
movie <- unique(movie)
```

Tidy genre column. Create one column per genre such that each is a dummy variable. One movie can be multiple genres.
This is tidy data, but for visualizations we will likely have to gather the various genre columns and make the data untidy to use genre as an aesthetic.
```{r movie_genre_tidy}
# use mtabulate from qdapTools package to create dummies for each genre 
genre_dummies <- mtabulate(strsplit(movie$genres, '\\|'))

# cbind with original data
movie <- cbind(movie, genre_dummies)

# make a tibble again
movie <- as.tibble(movie)
```

Exclude observations with missing revenue as this is our dependent variable.
```{r movie_grossna_drop}
movie <- filter(movie, !is.na(gross))
```

Exclude non-US movies. Tried to include these and apply a country-specific deflator to make real and then use exchange rates to get US dollars. However, after manually checking some IMDB pages, we realized that some movies that are made in foreign countries still report US Dollars and some don't. The unit isn't recorded, so there is no way to check this.  
Thus, we are excluding non-US movies to avoid misleading relationships between variables. 
```{r movie_nonus}
movie <- movie %>% filter(country == "USA")
```

## Deflator Data Cleaning

Basic cleaning: rename columns and create date variable
```{r deflator_clean}
deflator <- deflator %>%
  # rename columns
  rename(date = DATE, gdpd = GDPDEF) %>%
  # convert date column into a datetime 
  mutate(date = mdy(date))
```

Data is quarterly, but movie data is annual. Take average across quarters to get an annual deflator.
```{r deflator_annual}
deflator <- deflator %>% 
  # get year variable
  mutate(year = year(date)) %>% 
  # mean across quarters
  group_by(year) %>% 
  summarize(gdpd = mean(gdpd)) %>%
  # divide GDPD by 100 
  # (calculated as real / nominal * 100, so need to divide by 100 to reverse the conversion)
  mutate(gdpd = gdpd / 100)
```

## Oscar Data Cleaning

Rename all variables to be lower case  
```{r oscar_drop}
# rename variables to lower case 
oscar <- oscar %>% rename_all(tolower)
```

Clean the year variable: first few Oscars were two years (1930/1931 for example). Just take first year.

Year matters so that we can see how many Oscars they had won when each movie in the movie dataset was released. An actor earlier in their career with no Oscars would liekly have less of an impact on movie revenue than that same actor later in their career after 3 Oscars. 
  
Does not matter which film they won the award for.

```{r oscar_year}
oscar <- oscar %>% 
  # get first year if year variable has a / aka has two years
  mutate(year = ifelse(str_detect(year, '/'), str_split(year, '/', simplify = T)[,1], year),
    # make numeric instead of character
    year = as.numeric(year))
```

Filter: only include winners and acting and directing awards. One person can be an actor and a director, so make sure to differentiate.  
There are several types of acting and directing awards: make sure to get them all (but not art director etc.)

```{r oscar_filter}
actors <- oscar %>% 
  # winners only
  filter(winner == 1) %>%
  # acting and directing awards only 
  filter(str_detect(award, 'Actor') | str_detect(award, 'Actress'))

directors <- oscar %>% 
  # winners only
  filter(winner == 1) %>%
  # acting and directing awards only 
  filter(str_detect(award, 'Directing'))

# check these are the awards we want
unique(actors$award)
unique(directors$award)
```

Cleaning issue: For the first few years, the dataset lists director name under 'name' for the directing awards, as is logical. However, it switches in 1930 such that 'name' is the film name and 'film' is the director name

```{r oscar_directorclean}
directors <- directors %>% 
  mutate(name = ifelse(year >= 1930, film, name))
```

Expand the actor and director datasets so have full time series for each Actor. Mark when in that time series they earned each Oscar. Then can cumulatively sum so know number of Oscars at each year. 
```{r oscar_expand}

# actors
actors <- actors %>% 
  # drop unnecessary columns
  select(-c(ceremony, award, winner, film)) %>% 
  # indicate that they won an Oscar in this year 
  mutate(oscar = 1) %>% 
  # expand dataset so one year per actor 
  complete(year, name) %>%
  # fill in oscar dummy with zero when it is not 1 
  mutate(oscar = ifelse(is.na(oscar), 0, oscar))

# directors
directors <- directors %>% 
  # drop unnecessary columns
  select(-c(ceremony, award, winner, film)) %>% 
  # indicate that they won an Oscar in this year 
  mutate(oscar = 1) %>% 
  # expand dataset so one year per actor 
  complete(year, name) %>%
  # fill in oscar dummy with zero when it is not 1 
  mutate(oscar = ifelse(is.na(oscar), 0, oscar))
```

Cumulatively sum number of Oscars per actor/actress and director
```{r oscar_count}
actors <- actors %>%
  group_by(name) %>% 
  mutate(total_oscars = cumsum(oscar)) %>%
  select(-oscar)

directors <- directors %>%
  group_by(name) %>% 
  mutate(total_oscars = cumsum(oscar)) %>%
  select(-oscar)
```

## Merge Movie and Deflator Data by Year

```{r movie_deflator_merge}
# check if there are any non-matches
nonmatch <- movie %>% anti_join(deflator, by = 'year') 
unique(nonmatch$year)
  # years before 1947, which is when the deflator data starts. 
nonmatch %>% count()
  # 13 observations. OK to drop. 

# merge using an inner join. Want to drop any observations in movie that do not have a year in deflator (as above, 13 observations)
movie <- movie %>% inner_join(deflator, by = 'year')
```

## Convert nominal US dollars to real dollars

Use the deflator. Real = nominal / GDPD  

```{r deflate}
movie <- movie %>%
  mutate(real_budget = budget / gdpd,
         real_gross = gross / gdpd)
```

## Merge Movie and Actor Oscar Data 

Merge 4 times: once for each of the 3 actor columns in the movie dataset and once for director. Get the total number of oscars for that person at the time of the movie release.  
Left join so that we keep the rows with actors and directors that do not have Oscars
```{r movie_actor_merge}
movie <- movie %>% 
  # actor merge
  # rename because will merge in more variables with identical name
  left_join(actors, by = c('actor_1_name' = 'name', 'year')) %>%
  rename(total_oscars_actor1 = total_oscars) %>% 
  left_join(actors, by = c('actor_2_name' = 'name', 'year')) %>%
  rename(total_oscars_actor2 = total_oscars) %>%
  left_join(actors, by = c('actor_3_name' = 'name', 'year'), suffix = c('', '_actor3')) %>%
  rename(total_oscars_actor3 = total_oscars) %>%
  # director merge
  left_join(directors, by = c('director_name' = 'name', 'year'), suffix = c('', '_director')) %>%
  rename(total_oscars_director = total_oscars) %>%
  # replace missings for these 4 new variables with zero. Otherwise messes up math manipulations
  mutate_at(vars(total_oscars_actor1, total_oscars_actor2, total_oscars_actor3, total_oscars_director), 
            funs(ifelse(is.na(.), 0, .)))
```

Add together the number of oscars that the actors/actresses in that movie have earned. Only one director so that is all set. 
 
In the report, need to acknowledge that this is not at all a good measure of actor popularity. Many popular actors and actresses (and directors) never win Oscars. But an interesting measure none-the-less. Is the Academy in tune with what regular people want to see and will pay for? 
```{r movie_total_oscars}
movie <- movie %>% 
  mutate(total_oscars_actor = total_oscars_actor1 + total_oscars_actor2 + total_oscars_actor3) 