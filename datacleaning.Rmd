---
title: "Project Data Cleaning"
author: "Katrina Truebebach"
date: "March 4, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
library(stringr)
library(lubridate)
library(qdapTools)
#library(VIM)
#library(corrplot)
```

__Discovery__: The deflator data in the World Bank dataset is in local currency. The budget and revenue data in the movie dataset is also in local currency. Thus I needed to introduce an exchange rate dataset so that everything is in real US dollars.

## Download Data

Keep different file paths for different people
```{r import}
# Qiang's File Paths
#movie <- read_csv("D:/academic/DS 5110 Introduction to Data Management and Processing/project/movie_metadata.csv")
#oscar <- read_csv("D:/academic/DS 5110 Introduction to Data Management and Processing/project/academy_awards.csv")
#deflator <- read_csv("D:/academic/DS 5110 Introduction to Data Management and Processing/project/API_NY.GDP.DEFL.KD.ZG_DS2_en_csv_v2_10473736/API_NY.GDP.DEFL.KD.ZG_DS2_en_csv_v2_10473736.csv", skip = 4)

# Katrina's File Paths
movie <- read_csv("~/DS5110/data/movie_metadata.csv")
#oscar <- read_csv("~/DS5110/data/academy_awards.csv")
  # make sure to filter by winners (Winner == 1) and by Actor/Actress and Director
deflator <- read_csv("~/DS5110/data/GDPDEF.csv")
```

## Movie Data Cleaning

Drop some variables we are not using. Rename some variables
```{r movie_drop}
# drop variables we aren't using
movie <- movie %>% select(-c(color, contains('facebook'), starts_with('num_voted'), 
                             contains('link'), aspect_ratio, facenumber_in_poster,
                             plot_keywords))

# rename year variable so matches with keys in other datasets
# also rename country to country_name. 
  # When merge with othere datasets later, need to differentiate between country abbreviations and full names
movie <- movie %>% rename(year = title_year)
```

Clean up string variables: trim white space from all character variables 
```{r movie_string_clean}
movie <- movie %>%
  mutate_if(is.character, str_trim)
```

Drop rows that are entirely duplicated 
```{r movie_duplicate_drop}
sum(duplicated(movie)) # 120
movie <- unique(movie)
```

Tidy genre column. Create one column per genre such that each is a dummy variable. One movie can be multiple genres.
This is tidy data, but for visualizations we will likely have to gather the various genre columns and make the data untidy to use genre as an aesthetic.
```{r movie_genre_tidy}
# use mtabulate from qdapTools package to create dummies for each genre 
genre_dummies <- mtabulate(strsplit(movie$genres, '\\|'))

# cbind with original data
movie <- cbind(movie, genre_dummies)
```

Exclude observations with missing revenue as this is our dependent variable.
```{r movie_grossna_drop}
movie <- filter(movie, !is.na(gross))
```

Exclude non-US movies. Tried to include these and apply a country-specific deflator to make real and then use exchange rates to get US dollars. However, after manually checking some IMDB pages, we realized that some movies that are made in foreign countries still report US Dollars and some don't. The unit isn't recorded, so there is no way to check this.  
Thus, we are excluding non-US movies to avoid misleading relationships between variables. 
```{r movie_nonus}
movie <- movie %>% filter(country == "USA")
```

## Deflator Data Cleaning

Basic cleaning: rename columns and create date variable
```{r deflator_clean}
deflator <- deflator %>%
  # rename columns
  rename(date = DATE, gdpd = GDPDEF) %>%
  # convert date column into a datetime 
  mutate(date = mdy(date))
```

Data is quarterly, but movie data is annual. Take average across quarters to get an annual deflator.
```{r deflator_annual}
deflator <- deflator %>% 
  # get year variable
  mutate(year = year(date)) %>% 
  # mean across quarters
  group_by(year) %>% 
  summarize(gdpd = mean(gdpd)) %>%
  # divide GDPD by 100 
  # (calculated as real / nominal * 100, so need to divide by 100 to reverse the conversion)
  mutate(gdpd = gdpd / 100)
```

## Merge Movie and Deflator Data by Year

```{r movie_deflator_merge}
# check if there are any non-matches
nonmatch <- movie %>% anti_join(deflator, by = 'year') 
unique(nonmatch$year)
  # years before 1947, which is when the deflator data starts. 
nonmatch %>% count()
  # 13 observations. OK to drop. 

# merge using an inner join. Want to drop any observations in movie that do not have a year in deflator (as above, 13 observations)
movie <- movie %>% inner_join(deflator, by = 'year')
```

## Convert nominal US dollars to real dollars

Use the deflator. Real = nominal / GDPD  

```{r deflate}
movie <- movie %>%
  mutate(real_budget = budget / gdpd,
         real_gross = gross / gdpd)
```
