---
title: "Project Data Cleaning"
author: "Katrina Truebebach"
date: "March 4, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
library(stringr)
#library(VIM)
#library(corrplot)
```

__Discovery__: The deflator data in the World Bank dataset is in local currency. The budget and revenue data in the movie dataset is also in local currency. Thus I needed to introduce an exchange rate dataset so that everything is in real US dollars.

## Download Data

Keep different file paths for different people
```{r import}
# Qiang's File Paths
#movie <- read_csv("D:/academic/DS 5110 Introduction to Data Management and Processing/project/movie_metadata.csv")
#oscar <- read_csv("D:/academic/DS 5110 Introduction to Data Management and Processing/project/academy_awards.csv")
#deflator <- read_csv("D:/academic/DS 5110 Introduction to Data Management and Processing/project/API_NY.GDP.DEFL.KD.ZG_DS2_en_csv_v2_10473736/API_NY.GDP.DEFL.KD.ZG_DS2_en_csv_v2_10473736.csv", skip = 4)

# Katrina's File Paths
movie <- read_csv("~/DS5110/data/movie_metadata.csv")
#oscar <- read_csv("~/DS5110/data/academy_awards.csv")
  # make sure to filter by winners (Winner == 1) and by Actor/Actress and Director
deflator <- read_csv("~/DS5110/data/API_NY.GDP.DEFL.KD.ZG_DS2_en_csv_v2_10473736.csv", skip = 4)
exchange <- read_csv("~/DS5110/data/DP_LIVE_06032019024237951.csv")
country_codes <- read_csv("~/DS5110/data/country_codes.csv")
```

## Movie Data Cleaning

Drop some variables we are not using. Rename some variables
```{r movie_drop}
# drop variables we aren't using
movie <- movie %>% select(-c(color, contains('facebook'), starts_with('num_voted'), 
                             contains('link'), aspect_ratio, facenumber_in_poster,
                             plot_keywords))

# rename year variable so matches with keys in other datasets
# also rename country to country_name. 
  # When merge with othere datasets later, need to differentiate between country abbreviations and full names
movie <- movie %>% rename(year = title_year) %>% rename(country_name = country)
```

Clean up string variables: trim white space from all character variables 
```{r movie_string_clean}
movie <- movie %>%
  mutate_if(is.character, str_trim)
```

Drop rows that are entirely duplicated 
```{r movie_duplicate_drop}
sum(duplicated(movie)) # 120
movie <- unique(movie)
```

Tidy genre column. Separate into 8 columns: this is the maximum number of genres a movie has. Many movies will have many of these columns as NA.  
```{r movie_genre_tidy}
movie <- movie %>%
  separate(genres, into=c("g1", "g2", "g3", "g4", "g5", "g6", "g7", "g8"), sep="\\|")
```

Exclude observations with missing revenue as this is our dependent variable.
```{r movie_grossna_drop}
movie <- filter(movie, !is.na(gross))
```


In country variable, there is one instance of 'Official site' and one instance of 'New Line'. These movies are 'Country Strong' and 'Town & Country'. I manually checked and this is a data error and the movies are both US films.
```{r movie_datafix}
movie <- movie %>%
  mutate(country_name = ifelse(country_name == "Official site", 'USA', country_name),
         country_name = ifelse(country_name == 'New Line', 'USA', country_name))
```

## Deflator Data Cleaning

The deflator data is an implicit GDP deflator measured as ratio of GDP in local currency to GDP in constant local currency (nominal / real).

Drop columns we don't need. Also drop columns that are always NA (drops 1960, 2018, and X64). Rename columns.
```{r deflator_drop}
# drop columns we don't need
deflator <- deflator %>% select(-`Indicator Name`, -`Indicator Code`)

# drop columns that are always NA
deflator <- deflator %>% select_if(function(x) {!all(is.na(x))})

# rename country variable so consistent with country variable in movie dataset
deflator <- deflator %>% rename(country_name = `Country Name`, country_abbr = `Country Code`)
```

Reshape such that one column for year (currently each year is a variable). Make tidy.
```{r deflator_tidy}
# get list of year columns (numeric columns)
year_cols <- names(deflator)[unlist(lapply(deflator, is.numeric))]
# gather: one year column
deflator <- deflator %>%
  gather(year_cols, key = 'year', value = 'deflator')

# convert year column into numeric
deflator <- deflator %>%
  mutate(year = as.numeric(year))
```

## Clean Exchange Rate Data

Drop unnecessary columns and rename some columns.
```{r exchange_drop}
# keep location, time, and value columns
exchange <- exchange %>% select(LOCATION, TIME, Value) %>%
  # rename variables so consistent with other datasets
  rename(country_abbr = LOCATION,
         year = TIME, 
         exrate = Value)
```


## Clean Country Code Data

Drop unnecessary columns and rename columns. Keep official country name in English and the corresponding abbreviation.
```{r country_code_drop}
country_codes <- country_codes %>%
  # keep country name and code (english) columns
  select(official_name_en, `ISO3166-1-Alpha-3`) %>%
  # rename 
  rename(country_name = official_name_en, country_abbr = `ISO3166-1-Alpha-3`) 
```

Rename some of the country names to match the country names in movie dataset
```{r country_recode_countrylabel}
country_codes <- country_codes %>%
  mutate(country_name = ifelse(str_detect(country_name, 'Hong Kong'), 'Hong Kong', country_name),
         country_name = ifelse(str_detect(country_name, 'United Kingdom'), 'UK', country_name),
         country_name = ifelse(str_detect(country_name, 'United States of America'), 'USA', country_name),
         country_name = ifelse(str_detect(country_name, 'Republic of Korea'), 'South Korea', country_name),
         # Czech Republic also known as Czechia 
         country_name = ifelse(str_detect(country_name, 'Czech'), 'Czech Republic', country_name),
         country_name = ifelse(str_detect(country_name, 'Iran'), 'Iran', country_name),
         country_name = ifelse(str_detect(country_name, 'Russia'), 'Russia', country_name),
         country_name = ifelse(str_detect(country_name, 'Taiwan'), 'Iran', country_name),
         country_name = ifelse(str_detect(country_name, 'Iran'), 'Iran', country_name))

```

## Merge Movie, Deflator, and Exchange Rate

Merge country codes and movie dataset so can create a country abbreviations column for movie. Then can merge with exchange and deflator on that new column.  
First, use anti-join to look at any non-matches. They are Taiwan and West Germany. Since we do not have exchange rate data for these countries and they only represent 3 observations, we use an inner join to drop the non-mathces. 
```{r country_code_merge}
# check if any non-merges with anti-join: instances of country_name in movie that do not exist in country_codes
# Taiwan and West Germany. Do not have country codes for these but also do not have exchange rates. Excluding these three observations
movie %>% anti_join(country_codes, by = 'country_name') %>% select(country_name)

# merge with inner join. Drop Germany and Taiwan observations i.e. any observations that do not exist in both datasets
movie <- movie %>% 
  inner_join(country_codes, by = 'country_name')

```

Use new country_abbr column in movies to merge in both deflator and exchange rate dataset by country and year.  
First, use anti-join to look at any non-matches.
Left join such that only include deflators and exchange rates from countries and years in which we have a movie observation.
```{r movie_deflator_merge}

## PICK UP HERE: investigate these non matches and decide what to do
  # check years: movie data back to 1920s sometimes but we don't have exchange etc data back that far
    # how many observations? Ok to drop?
  # any countries in the appropriate years?

# check for non-matches
nonmatch <- movie %>% anti_join(exchange, by = c('year', 'country_abbr')) %>% select(year, country_abbr, country_name)
unique(nonmatch$country_abbr)

nonmatch <- movie %>% anti_join(deflator, by = c('year', 'country_abbr')) %>% select(year, country_abbr, country_name)
unique(nonmatch$country_abbr)

# merge: WHAT KIND OF MERGE?
#movie <- movie %>% 
#  # merge deflator dataset by year and country abbreviation
#  left_join(deflator, by = c('year', 'country_abbr')) %>%
#  # merge exchange dataset by year and country abbreviation
#  left_join(exchange, by = c('year', 'country_abbr'))

```

## Convert nominal local currency values into US real dollars.
Budget and gross revenue.

Process: convert local currency into real local currency (real local currency = local currency / local deflator). Then convert real local currency into real US dollars (real local currency / exchange rate).   

```{r real}
```